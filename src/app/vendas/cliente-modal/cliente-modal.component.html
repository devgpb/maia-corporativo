<app-modal class="cliente-edit-modal position-relative">
  <div class="p-3 position-relative">

    <!-- Ações no topo direito (fixas) -->
    <div class="modal-top-actions position-absolute top-0 end-0 p-2 d-flex gap-2">
      @if (!mostrarHistoricoLigacoes) {
        <button type="button" class="btn btn-sm btn-outline-primary" (click)="abrirHistoricoLigacoes()">
          <ng-icon name="lucidePhoneCall" class="me-1" size="16"></ng-icon>
          Histórico de Ligações
        </button>
      }
      @if (mostrarHistoricoLigacoes) {
        <button type="button" class="btn btn-sm btn-outline-secondary" (click)="voltarParaEdicao()">
          <ng-icon name="lucideArrowLeft" class="me-1" size="16"></ng-icon>
          Voltar
        </button>
      }
      <button type="button" class="btn btn-sm btn-outline-secondary" (click)="close()" aria-label="Fechar">
        <ng-icon name="lucideX" size="18"></ng-icon>
      </button>
    </div>

    <!-- Botão Delete isolado, sempre no canto superior esquerdo -->
    <button
      class="btn btn-danger mb-2"
      type="button"
      (click)="delete()"
      [disabled]="isLoading"
      aria-label="Apagar Cliente"
      >
      <ng-icon name="lucideTrash2" class="" size="18"></ng-icon>
    </button>

    @if (formData) {
      <div>
        @if (formData?.fechado) {
          <div class="alert alert-warning d-flex align-items-center gap-2 mb-3 rounded-3 shadow-sm">
            <ng-icon name="lucideAlertTriangle" size="18"></ng-icon>
            <div>
              <strong>Cliente fechado</strong> em
              <strong>{{ formData.fechado | date:'dd/MM/yyyy HH:mm' }}</strong>.
            </div>
          </div>
        }
        <!-- Nome de quem cadastrou -->
        <div class="bg-light rounded p-3 mb-4 text-center">
          <span class="fw-normal">Cadastrado por:</span>
          <div class="fw-bold fs-5">{{ formData?.responsavel?.nomeCompleto }}</div>
        </div>
        <!-- Datas separadas -->
        <div class="bg-white rounded p-3 shadow-sm">
          <!-- Criado -->
          <div class="d-flex justify-content-between align-items-center border-bottom pb-2 mb-2">
            <span class="fw-bold text-primary">Data de Criação</span>
            <span>{{ formData.createdAt | date:'dd/MM/yyyy HH:mm' }}</span>
          </div>
          <!-- Atualizado -->
          <div class="d-flex justify-content-between align-items-center border-bottom pb-2 mb-2">
            <span class="fw-bold text-success">Última Atualização</span>
            <span>{{ formData.updatedAt | date:'dd/MM/yyyy HH:mm' }}</span>
          </div>
          <!-- Último Contato (opcional) -->
          @if (formData.ultimoContato) {
            <div class="d-flex justify-content-between align-items-center">
              <span class="fw-bold text-warning">Último Contato</span>
              <span>{{ formData.ultimoContato | date:'dd/MM/yyyy HH:mm' }}</span>
            </div>
          }
        </div>
        <!-- Métricas de tempo -->
        <div class="mt-3 d-flex align-items-center justify-content-between">
          <span>
            Criado há {{ calcularDias(formData.createdAt) }} {{ calcularDias(formData.createdAt) === 1 ? 'dia' : 'dias' }}
          </span>
          <span class="badge" [ngClass]="getBadgeClass(calcularDias(formData.createdAt))">
            {{ getBadgeText(calcularDias(formData.createdAt)) }}
          </span>
        </div>
        <!-- Cabeçalho -->
        <div class="d-flex justify-content-between align-items-center mb-3">
          <h5 class="mb-0">
            {{ mostrarHistoricoLigacoes ? 'Histórico de Ligações' : 'Editar Cliente #' + formData.idCliente }}
          </h5>
        </div>
        @if (!mostrarHistoricoLigacoes) {
        <!-- Formulário -->
        <form>
          <div class="row">
            <div class="col-md-6 mb-3">
              <label class="form-label">Nome *</label>
              <input
                type="text"
                class="form-control"
                [(ngModel)]="formData.nome"
                name="nome"
                (ngModelChange)="clearError('nome')"
                [class.is-invalid]="errors['nome']"
                />
                @if (errors['nome']) {
                  <div class="invalid-feedback">
                    {{ errors['nome'] }}
                  </div>
                }
              </div>
              <div class="col-md-6 mb-3">
                <label class="form-label">Celular *</label>
                <input
                  type="text"
                  class="form-control"
                  appMask="celular"
                  placeholder="(99) 99999-9999"
                  [(ngModel)]="formData.celular"
                  name="celular"
                  (ngModelChange)="clearError('celular')"
                  [class.is-invalid]="errors['celular']"
                  />
                  @if (errors['celular']) {
                    <div class="invalid-feedback">
                      {{ errors['celular'] }}
                    </div>
                  }
                </div>
                <div class="col-md-6 mb-3">
                  <label class="form-label">Cidade</label>
                  <ng-select
                    [items]="cidades"
                    [(ngModel)]="formData.cidade"
                    name="cidade"
                    [searchable]="true"
                    [clearable]="true"
                    [hideSelected]="true"
                    [addTag]="true"
                    placeholder="Digite ou selecione..."
                    (add)="onAddCidade($event)">
                  </ng-select>
                </div>

                <div class="col-md-6 mb-3">
                  <label class="form-label">Status</label>
                  <ng-select
                    [items]="statuses"
                    [(ngModel)]="formData.status"
                    name="status"
                    [searchable]="true"
                    [clearable]="true"
                    [hideSelected]="true"
                    [addTag]="true"
                    placeholder="Digite ou selecione..."
                    (add)="onAddStatus($event)"
                    [disabled]="isFechado"
                    >
                  </ng-select>
                </div>
                  <div class="col-md-6 mb-3">
                    <label class="form-label">Campanha</label>
                    <ng-select
                      [items]="listaCampanhas"
                      [(ngModel)]="formData.campanha"
                      name="campanha"
                      [searchable]="true"
                      [clearable]="true"
                      [hideSelected]="true"
                      [addTag]="true"
                      placeholder="Digite ou selecione..."
                      (add)="onAddCampanha($event)">
                    </ng-select>
                  </div>
                  <div class="col-md-6 mb-3">
                    <label class="form-label">Indicação</label>
                    <input
                      type="text"
                      class="form-control"
                      [(ngModel)]="formData.indicacao"
                      name="indicacao"
                      />
                    </div>
                    <div class="col-12 mb-3">
                      <label class="form-label">Observações</label>
                      <textarea
                        class="form-control"
                        rows="3"
                        [(ngModel)]="formData.observacao"
                        name="observacao">
                      </textarea>
                    </div>
                  </div>
        </form>

        <!-- ===================== SESSÃO: EVENTOS ===================== -->
        <div class="mt-4 mb-5">
          <div class="d-flex align-items-center justify-content-between mb-2">
            <h6 class="mb-0">Eventos do Cliente</h6>
            <span class="text-muted small">{{ eventos.length }} registro(s)</span>
          </div>

          <!-- Form de marcação -->
          <div class="bg-white rounded p-3 shadow-sm mb-3">
            <div class="row g-2 align-items-end">
              <div class="col-md-5">
                <label class="form-label">Título do evento (opcional)</label>
                <input
                  type="text"
                  class="form-control"
                  [(ngModel)]="evTitulo"
                  name="evTitulo"
                  placeholder="Ex.: Retorno, Visita, Apresentação"
                />
              </div>
              <div class="col-md-3">
                <label class="form-label">Data *</label>
                <input
                  type="text"
                  class="form-control"
                  bsDatepicker
                  [(ngModel)]="evData"
                  name="evData"
                  [bsConfig]="dpConfig"
                  [minDate]="today"
                  placeholder="dd/mm/aaaa"
                  (bsValueChange)="onDateChange($event)"
                />
              </div>
              <div class="col-md-4">
                <label class="form-label">Hora (opcional)</label>
                <div class="input-group">
                  <button type="button" class="btn btn-outline-secondary" (click)="adjustHour(-1)">
                    <ng-icon name="lucideMinus" size="16"></ng-icon>
                  </button>

                  <input
                    type="time"
                    class="form-control text-center"
                    [(ngModel)]="evHora"
                    name="evHora"
                    step="60"
                  />

                  <button type="button" class="btn btn-outline-secondary" (click)="adjustHour(1)">
                    <ng-icon name="lucidePlus" size="16"></ng-icon>
                  </button>
                </div>
              </div>
              <div class="col-md-2 w-100 d-flex justify-content-end">
                <button
                  class="btn btn-success"
                  type="button"
                  (click)="marcarEvento()"
                  [disabled]="isSavingEvento"
                >
                  <ng-icon name="lucideCalendarPlus" class="me-2" size="18"></ng-icon>
                  Marcar
                </button>
              </div>
            </div>
            <div class="text-muted small mt-2">
              * Se não informar hora, será considerado 00:00 no seu fuso ({{ tz }}).
            </div>
          </div>

          <!-- Lista de eventos (cards responsivos) -->
          <div class="row row-cols-1 row-cols-sm-2 row-cols-lg-3 g-2">
            @for (ev of eventos; track ev.idEvento; let i = $index) {
              <div class="col">
                <div class="card h-100 shadow-sm border-0 p-2"
                    [ngClass]="ev._anim"
                    style="border-radius: 12px;">
                  <div class="card-body d-flex flex-column gap-2">
                    <div class="d-flex justify-content-between align-items-center">
                      <div class="fw-bold">
                        {{ ev.dataLocal }}
                      </div>
                      <span
                        class="badge"
                        [ngClass]="ev.confirmado ? 'bg-success' : 'bg-warning text-dark'">
                        {{ ev.confirmado == null ? 'Pendente' : ev.confirmado ? 'Confirmado' : 'Cancelado'}}
                      </span>
                    </div>

                    <div class="text-muted">
                      {{ ev.evento || 'Evento sem título' }}
                    </div>

                    <div class="mt-auto d-flex gap-2">
                      @if (ev.confirmado == null) {
                        <button class="btn btn-sm btn-primary flex-fill"
                                (click)="confirmarEventoLocal(ev)">
                          <ng-icon name="lucideCheckCircle" class="me-1" size="16"></ng-icon>
                          Confirmar
                        </button>
                      }
                      @if (ev.confirmado == null) {
                        <button class="btn btn-sm btn-outline-danger flex-fill"
                                (click)="cancelarEventoLocal(ev)">
                          <ng-icon name="lucideXCircle" class="me-1" size="16"></ng-icon>
                          Cancelar
                        </button>
                     }
                    </div>
                  </div>
                </div>
              </div>
              <!-- Se for o último evento da mesma data -->
              <!-- @if (i === eventos.length - 1 || !mesmaData(ev, eventos[i + 1])) {
                <div class="w-100"></div>
              } -->
            }
          </div>

          @if (isLoadingEventos) {
            <div class="text-center text-muted py-3">Carregando eventos…</div>
          }
          @if (!isLoadingEventos && eventos.length === 0) {
            <div class="text-center text-muted py-3">Nenhum evento cadastrado.</div>
          }
        </div>

        <!-- =================== FIM SESSÃO: EVENTOS =================== -->
        <!-- P A R   (Salvar + Fechar/Reabrir) -->
        <div class="d-flex flex-column gap-2 w-100 mb-3">
          <!-- Ações lado a lado no desktop -->
          <div class="modal-footer d-flex flex-column flex-sm-row gap-2 justify-content-end mt-3 p-0 border-0">
            <button class="btn btn-primary w-100 w-sm-auto" (click)="save()" [disabled]="isLoading">
              <ng-icon name="lucideSave" class="me-2" size="18"></ng-icon> Salvar
            </button>

            <button
              class="btn w-100 w-sm-auto"
              [ngClass]="isFechado ? 'btn-success' : 'btn-warning'"
              (click)="toogleFecharCliente()"
              [disabled]="isLoading">
              <ng-icon [name]="isFechado ? 'lucideUnlock' : 'lucideReceipt'" class="me-2" size="18"></ng-icon>
              {{ isFechado ? 'Reabrir Cliente' : 'Fechar Cliente' }}
            </button>
          </div>

          <!-- Cancelar sempre em linha separada e ocupando 100% -->
          <button type="button" class="btn btn-outline-secondary w-100" (click)="close()" [disabled]="isLoading">
            <ng-icon name="lucideXCircle" class="me-2" size="18"></ng-icon> Cancelar
          </button>
        </div>
        }

        @if (mostrarHistoricoLigacoes) {
          <!-- ================= HISTÓRICO DE LIGAÇÕES ================= -->
          <div class="bg-white rounded p-3 shadow-sm">
            <div class="d-flex justify-content-between align-items-center mb-2">
              <span class="text-muted small">Total: {{ ligacoes.length }}</span>
            </div>

            @if (isLoadingLigacoes) {
              <div class="text-center text-muted py-3">Carregando histórico…</div>
            }

            @if (!isLoadingLigacoes && ligacoes.length === 0) {
              <div class="text-center text-muted py-3">Nenhuma ligação registrada.</div>
            }

            @if (!isLoadingLigacoes && ligacoes.length > 0) {
              <!-- Mobile: Cards -->
              <div class="d-md-none">
                <div class="d-flex flex-column gap-2">
                  @for (l of ligacoes; track l.idLigacao) {
                    <div class="border rounded-3 p-3 shadow-sm lig-card">
                      <div class="d-flex justify-content-between align-items-center mb-1">
                        <div class="fw-semibold">{{ l.data | date:'dd/MM/yyyy' }}</div>
                        <span class="badge" [ngClass]="l.atendido ? 'bg-success' : 'bg-secondary'">
                          {{ l.atendido ? 'Sim' : 'Não' }}
                        </span>
                      </div>
                      <div class="text-muted small mb-2">Registrado em {{ l.createdAt | date:'dd/MM/yyyy HH:mm' }}</div>
                      <div class="text-break">{{ l.observacao || '-' }}</div>
                    </div>
                  }
                </div>
              </div>

              <!-- Desktop: Tabela -->
              <div class="table-responsive d-none d-md-block">
                <table class="table table-sm align-middle">
                  <thead>
                    <tr>
                      <th>Data</th>
                      <th>Registrado em</th>
                      <th>Atendido</th>
                      <th>Observação</th>
                    </tr>
                  </thead>
                  <tbody>
                    @for (l of ligacoes; track l.idLigacao) {
                      <tr>
                        <td>{{ l.data | date:'dd/MM/yyyy' }}</td>
                        <td>{{ l.createdAt | date:'dd/MM/yyyy HH:mm' }}</td>
                        <td>
                          <span class="badge" [ngClass]="l.atendido ? 'bg-success' : 'bg-secondary'">
                            {{ l.atendido ? 'Sim' : 'Não' }}
                          </span>
                        </td>
                        <td class="text-break">{{ l.observacao || '-' }}</td>
                      </tr>
                    }
                  </tbody>
                </table>
              </div>
            }
          </div>
          <!-- =============== FIM HISTÓRICO DE LIGAÇÕES =============== -->
        }

      </div>
    }
  </div>
</app-modal>
